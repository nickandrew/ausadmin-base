#!/bin/bash
#	@(#) mkvote: Setup everything needed to start a new vote.
#	This script only works for a single newsgroup.
#
#  - Create the vote control files
#  - Create the Call For Votes
#  - Post Call For Votes into the group distribution list

# $Source$
# $Revision$
# $Date$

if [ $# -lt 1 ]
then
	echo usage: $0 newsgroup-name >&2
	exit 1
fi

# Get command line arguments
Newsgroup="$1"

# Commonly used variables
HomeDir=~ausadmin
BaseDir=$HomeDir/vote

# set up common environment

cd $BaseDir

# Check that vote directory exists, and other files needed to create a vote
if [ ! -d $Newsgroup ] ; then
	echo No directory $BaseDir/$Newsgroup
	exit 8
fi

# Expect all these files ..
s=0
for i in charter distribution ngline proposer rationale ; do
	if [ ! -f $Newsgroup/$i ] ; then
		echo Missing $Newsgroup/$i - run new-rfd first
		s=8
	fi
fi

if [ $s != 0 ] ; then
	echo Unable to make vote due to missing RFD files
	exit $s
fi

if [ -e $Newsgroup/endtime.cfg ] ; then
	echo Vote already started on $Newsgroup
	exit 8
fi

cp ~/config/voterule $Newsgroup/voterule

~/bin/setup-vote $Newsgroup

# This will be obsoleted by vote_start.cfg soon
cp $Newsgroup/vote_start.cfg $Newsgroup/starttime.cfg

# echo `date +%s` > $Newsgroup/starttime.cfg

# Run the Perl script mkcfv to make the CFV and PGP-sign it then post it away!
mkcfv.pl $Newsgroup > $Newsgroup/posted.cfv 2>$HomeDir/tmp/pgp.$$
s=$?
if [ $s != 0 ] ; then
	echo "Unable to make Call For Votes -- code $s - fatal"
	cat $Newsgroup/posted.cfv 2>$HomeDir/tmp/pgp.$$
	exit 7
fi

rm -f $HomeDir/CFV/$Newsgroup
ln -s $BaseDir/$Newsgroup/posted.cfv $HomeDir/CFV/$Newsgroup


# Post the CFV
echo `date +%s` > $Newsgroup/posted.cfg
~/bin/post.pl < $BaseDir/$Newsgroup/posted.cfv

echo Done at `date`
exit 0
