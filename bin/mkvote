#!/bin/sh

# Setup everything needed to start a new vote.
#  - Create the usevote.cfg file
#  - Create the Call For Votes
#  - Post Call For Votes in aus.general and aus.net.news

if [ $# -lt 1 ]
then
	echo usage: $0 newsgroup-name charter-info-file >&2
	exit 1
fi

# Get command line arguments
Newsgroup="$1"
Info="$2"

# Commonly used variables
HomeDir=/virt/web/ausadmin
BaseDir=$HomeDir/vote

# make directories if they don't already exist
gendirs ()
{
	for dir in $*
	do
		if [ ! -d $dir ]
		then
			mkdir $dir
		fi
	done
}

# set up common environment
cp $Info $HomeDir/tmp/info.$$
s=$?
if [ $s != 0 ] ; then
	echo "Unable to copy $Info - fatal"
	exit 5
fi

cd $BaseDir

# set up control files

gendirs $Newsgroup $Newsgroup/conf $Newsgroup/votes 
echo "2 3 40" > $Newsgroup/voterule
echo "14" > $Newsgroup/voteperiod
echo `date +%s` > $Newsgroup/posted.cfg
perl -e 'print $^T,"\n"' > $Newsgroup/starttime.cfg

# Run the Perl script mkcvf to make the CFV and PGP-sign it then post it away!
tr -d '\r' < $HomeDir/tmp/info.$$ | mkcfv.pl > $Newsgroup/posted.cfv 2>$HomeDir/tmp/pgp.$$
S=$?
if [ $s != 0 ] ; then
	echo "Unable to make Call For Votes -- code $s - fatal"
	cat $Newsgroup/posted.cfv 2>$HomeDir/tmp/pgp.$$
	exit 7
fi

rm -f $HomeDir/CFV/$Newsgroup
ln -s $BaseDir/$Newsgroup/posted.cfv $HomeDir/CFV/$Newsgroup

# Post the CFV
~/bin/post.pl < $BaseDir/$Newsgroup/posted.cfv


echo Done at `date`
exit 0
