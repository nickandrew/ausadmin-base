#!/bin/sh

# Setup everything needed to start a new vote.
#  - Create the usevote.cfg file
#  - Create the Call For Votes
#  - Post Call For Votes in aus.general and aus.net.news

if [ $# -lt 1 ]
then
	echo usage: $0 newsgroup-name charter-info-file >&2
	exit 1
fi

# Get command line arguments
Newsgroup=$1
Info=$2

# Commonly used variables
HomeDir=/virt/web/ausadmin
BaseDir=$HomeDir/vote

# make directories if they don't already exist
gendirs ()
{
	for dir in $*
	do
		if [ ! -d $dir ]
		then
			mkdir $dir
		fi
	done
}

# set up common environment
cp $Info $BaseDir/tmp/info.$$
s=$?
if [ $s != 0 ] ; then
	echo "Unable to copy $Info - fatal
	exit 5
fi

cd $BaseDir

# set up directories
gendirs $Newsgroup $Newsgroup/conf $Newsgroup/votes 
echo "2 3 10" > $Newsgroup/conf/voterule
echo "14" > $Newsgroup/conf/voteperiod

# Run the Perl script mkcvf to make the CFV and PGP-sign it then post it away!
tr -d '\r' < $Info | $BaseDir/bin/mkcfv.pl | pgp -f > $BaseDir/$Newsgroup/conf/posted.cfv
ln -s $BaseDir/$Newsgroup/conf/posted.cfv $HomeDir/CFV/$Newsgroup

# Post the CFG
inews -h < $BaseDir/$Newsgroup/conf/posted.cfv
echo `date +%s` > $BaseDir/$Newsgroup/conf/posted.cfg
