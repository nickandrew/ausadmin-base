#!/bin/sh
#	@(#) new-rfd: Setup directories for newsgroup proposals
#	Usage: new-rfd newsgroup-name rfd-file
#
# The idea is that the ausadmin-approved RFD message is fed into this
# program and it will create needed directories and generate a new,
# postable RFD. You will be asked for your passphrase for signing the
# new RFD.
#
# $Source$
# $Revision$
# $Date$

if [ $# -lt 2 ]
then
	echo Usage: $0 newsgroup-name rfd-file >&2
	exit 1
fi

# Get command line arguments
Newsgroup="$1"
Info="$2"

# Commonly used variables
BaseDir=./vote

if [ ! -d $BaseDir ] ; then
	echo "new-rfd: No directory $BaseDir - cd?" >&2
	exit 4
fi

# Parse the RFD and create appropriate files:
#	- newsgroup directory
#	- $newsgroup/proposer, /distribution, /charter, /rationale, /ngline,
#	  /modinfo

ts=`date '+%Y%m%d-%H%M%S'`
fn=RFD/$ts.rfd

mkdir -p RFD

echo Parsing $fn ...

tr -d '\r' < $Info > $fn
s=$?

if [ $s != 0 ] ; then
	echo "Unable to tr $Info -- code $s - fatal"
	exit 6
fi

bin/parse-rfd.pl < $fn
s=$?

if [ $s != 0 ] ; then
	echo "Unable to parse rfd $fn -- code $s - fatal"
	exit 6
fi

bin/make-rfd.pl $Newsgroup | bin/sign.pl > $BaseDir/$Newsgroup/rfd
s=$?

if [ $s != 0 ] ; then
	echo "Unable to create new rfd for $Newsgroup -- code $s - fatal"
	exit 6
fi

echo new-rfd Done at `date`
echo "You now have to edit $BaseDir/$Newsgroup/rfd (perhaps), sign it, post it, create rfd_posted.cfg"

exit 0
