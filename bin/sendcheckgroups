#!/bin/bash
#	@(#) bin/sendcheckgroup - Create/post newsgroup list and checkgroups
#
# $Source$
# $Revision$
# $Date$

umask 022

# Recreate ausgroups first
bin/gen-ausgroups.pl
s=$?
if [ $s -ne 0 ] ; then
	echo "bin/gen-ausgroups.pl returned status $s - fatal"
	exit 2
fi

bin/gengrouplist.pl > tmp/grouplist.$$
s=$?
if [ $s -ne 0 ] ; then
	echo "bin/gengrouplist.pl returned status $s - fatal"
	rm -f tmp/grouplist.$$
	exit 2
fi

bin/pgp-sign < tmp/grouplist.$$ > tmp/signed-grouplist.$$
s=$?
if [ $s -ne 0 ] ; then
	echo "pgp-sign returned status $s - fatal"
	rm -f tmp/grouplist.$$ tmp/signed-grouplist.$$
	exit 4
fi

rm -f tmp/grouplist.$$

bin/gen-checkgroups.pl
s=$?
if [ $s -ne 0 ] ; then
	echo "bin/gencheckgroups.pl returned status $s - fatal"
	exit 3
fi

# Replace the current version with the latest

mv tmp/signed-grouplist.$$ data/grouplist.msg

#----------------------------------------------------------------------------
#  Post the messages
#----------------------------------------------------------------------------

rc=0
bin/post.pl < data/grouplist.msg
s=$?
if [ $s -ne 0 ] ; then
	echo "post.pl submission of data/grouplist.msg returned status $s"
	rc=8
fi

bin/post.pl < data/checkgroups.msg
s=$?
if [ $s -ne 0 ] ; then
	echo "post.pl submission of data/checkgroups.msg returned status $s"
	rc=8
fi

exit $rc
